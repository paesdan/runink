#!/usr/sbin/nft -f

# ==============================
# NFTABLES CONFIG FOR RUNINK NODE
# ==============================

flush ruleset

table inet filter {

  chain input {
    type filter hook input priority 0; policy drop;

    # Allow loopback
    iif lo accept

    # Allow established connections
    ct state established,related accept

    # Allow SSH (optional debugging)
    tcp dport 22 ct state new accept

    # === Control Plane Services ===
    tcp dport { 8443, 8500 } ct state new accept

    # === Herd Partition Services ===
    tcp dport { 8700, 8701, 8800, 8801, 8900, 8901 } ct state new accept

    # === Worker Node Services ===
    tcp dport { 9000, 9100, 9200, 9300 } ct state new accept

    # === Ephemeral Slice Services ===
    ip saddr 10.0.0.0/8 tcp dport 30000-32767 ct state new accept
    tcp dport 30000-32767 ct state new ct count over 50 drop comment "Conntrack limit 50 per slice"

    # === ICMP (Ping) (Optional) ===
    icmp type echo-request accept

    # === Drop Anything Else ===
    counter drop
  }

  chain forward {
    type filter hook forward priority 0; policy drop;
  }

  chain output {
    type filter hook output priority 0; policy accept;
  }
}
